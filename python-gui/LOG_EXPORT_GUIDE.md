# 日志导出功能使用指南

## 功能概述

系统现在支持按运行会话管理日志，每次运行都会生成唯一的会话ID，并支持多种方式导出日志，方便用户查看和分析不同运行会话的日志信息。

## 新增功能

### 1. 会话管理
- **会话ID生成**: 每次开始飞书异步批量处理时自动生成唯一会话ID
- **格式**: `feishu_async_YYYYMMDD_HHMMSS`
- **会话存储**: 每个会话的日志独立存储，便于管理

### 2. 日志标识
- **会话标识**: 每条日志都包含会话信息 `[会话:session_id]`
- **系统日志**: 非会话相关的日志标记为 `[系统]`
- **时间戳**: 每条日志都包含精确的时间戳

### 3. 多种导出方式
- **导出当前日志**: 导出当前显示区域的所有日志
- **导出选中会话**: 导出指定会话的所有日志
- **导出所有日志**: 导出所有会话的日志到一个文件

## 界面布局

### 日志控制区域
- **会话选择**: 下拉框选择要查看的会话
- **刷新会话**: 刷新会话列表
- **导出按钮**: 四种不同的导出选项

### 操作按钮
1. **清空日志**: 清空当前显示的日志
2. **导出当前日志**: 导出当前显示区域的内容
3. **导出选中会话**: 导出选中的特定会话日志
4. **导出所有日志**: 导出所有会话的日志

## 使用方法

### 1. 查看会话日志
1. 在"运行日志"标签页中，选择"选择会话"下拉框
2. 选择要查看的会话ID
3. 日志显示区域会显示该会话的所有日志

### 2. 导出当前日志
1. 点击"导出当前日志"按钮
2. 选择保存位置和文件名
3. 系统会导出当前显示区域的所有日志

### 3. 导出选中会话
1. 在会话下拉框中选择要导出的会话
2. 点击"导出选中会话"按钮
3. 选择保存位置，系统会自动建议文件名格式：`log_session_id.txt`

### 4. 导出所有日志
1. 点击"导出所有日志"按钮
2. 选择保存位置，系统会自动建议文件名格式：`all_logs_YYYYMMDD_HHMMSS.txt`
3. 系统会导出所有会话的日志，按会话分组

## 技术实现

### 1. 会话管理
```python
# 生成会话ID
self.current_session_id = f"feishu_async_{datetime.now().strftime('%Y%m%d_%H%M%S')}"

# 存储会话日志
self.session_logs = {}  # 存储各会话的日志
```

### 2. 日志记录
```python
def log_message(self, message: str):
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    session_info = f"[会话:{self.current_session_id}]" if self.current_session_id else "[系统]"
    log_entry = f"[{timestamp}] {session_info} {message}\n"
    
    # 存储到当前会话日志
    if self.current_session_id:
        if self.current_session_id not in self.session_logs:
            self.session_logs[self.current_session_id] = []
        self.session_logs[self.current_session_id].append(log_entry.strip())
```

### 3. 导出功能
- **当前日志导出**: 直接导出显示区域内容
- **会话日志导出**: 从`session_logs`字典中获取指定会话的日志
- **所有日志导出**: 遍历所有会话，按会话分组导出

## 文件格式

### 单个会话日志文件
```
[2024-01-08 10:30:15] [会话:feishu_async_20240108_103015] 开始获取飞书内容...
[2024-01-08 10:30:16] [会话:feishu_async_20240108_103015] 成功获取飞书内容，共5条记录
[2024-01-08 10:30:17] [会话:feishu_async_20240108_103015] 开始飞书异步批量处理...
```

### 所有日志文件
```
=== 所有会话日志 ===

=== 会话: feishu_async_20240108_103015 ===
[2024-01-08 10:30:15] [会话:feishu_async_20240108_103015] 开始获取飞书内容...
[2024-01-08 10:30:16] [会话:feishu_async_20240108_103015] 成功获取飞书内容，共5条记录

=== 会话: feishu_async_20240108_104530 ===
[2024-01-08 10:45:30] [会话:feishu_async_20240108_104530] 开始获取飞书内容...
[2024-01-08 10:45:31] [会话:feishu_async_20240108_104530] 成功获取飞书内容，共3条记录
```

## 优势

### 1. 会话隔离
- 每次运行的日志独立存储，不会相互干扰
- 可以单独查看和分析特定运行会话的日志

### 2. 灵活导出
- 支持多种导出方式，满足不同需求
- 自动生成有意义的文件名

### 3. 时间追踪
- 每条日志都有精确的时间戳
- 会话ID包含时间信息，便于识别

### 4. 易于管理
- 会话列表按时间倒序排列
- 支持刷新会话列表
- 清晰的界面布局

## 注意事项

1. **会话ID唯一性**: 基于时间戳生成，确保每次运行都有唯一标识
2. **内存管理**: 会话日志存储在内存中，重启应用后会丢失
3. **文件编码**: 所有导出的日志文件都使用UTF-8编码
4. **日志限制**: 显示区域限制1000行，但导出时包含完整日志
5. **会话选择**: 选择会话后会自动清空当前显示并加载该会话的日志
