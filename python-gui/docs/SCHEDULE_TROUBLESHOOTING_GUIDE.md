# 定时任务故障排除指南

## 问题诊断

### 22:11定时任务没有执行的可能原因

1. **时间已过**：当前时间22:13，定时任务设置22:11，时间已过
2. **GUI未运行**：定时任务需要GUI应用运行才能执行
3. **调度器线程问题**：调度器线程可能没有正常启动
4. **工作流配置问题**：工作流配置可能不正确

## 解决方案

### 1. 立即测试定时任务

运行手动测试工具：
```bash
python test_schedule_manual.py
```

选择选项2，输入任务ID `08ad6885-0505-4c29-acf2-48fc8bca7f32` 来模拟执行。

### 2. 检查调度器状态

在GUI中查看日志输出，应该能看到：
- "调度器已启动"
- "调度器运行中，当前时间: XX:XX"（每5分钟一次）

### 3. 重置任务状态

如果任务从未运行过，可以重置最后运行时间：
```bash
python test_schedule_manual.py
```
选择选项3，输入任务ID来重置。

### 4. 设置新的测试时间

将定时任务时间设置为当前时间后几分钟，例如：
- 当前时间：22:13
- 设置时间：22:15
- 等待2分钟后观察是否执行

## 改进的调度器功能

### 新增调试日志

调度器现在会输出详细的调试信息：
- 每5分钟输出当前时间
- 发现匹配任务时输出详细信息
- 重复检查结果
- 执行状态

### 容错机制

- 更好的异常处理
- 时间解析错误处理
- 详细的错误日志

## 定时任务执行条件

### 基本条件
1. 任务必须启用（enabled: true）
2. 当前时间必须与设置时间完全匹配
3. 调度器线程必须正常运行

### 重复检查
- **每天**：距离上次运行至少1天
- **每周**：距离上次运行至少7天
- **每月**：距离上次运行至少30天

## 工作流类型支持

### 手动生成工作流
- 需要工作流配置存在
- 执行简单的内容生成

### 飞书异步批量工作流
- 需要飞书配置完整
- 支持模板配置
- 执行批量视频生成

## 常见问题

### Q: 定时任务设置后没有执行
A: 检查以下几点：
1. GUI是否正在运行
2. 时间是否匹配（精确到分钟）
3. 任务是否启用
4. 查看日志输出

### Q: 任务执行了一次就不再执行
A: 检查重复设置：
1. 每天：需要等待24小时
2. 每周：需要等待7天
3. 每月：需要等待30天

### Q: 如何立即测试定时任务
A: 使用手动测试工具：
```bash
python test_schedule_manual.py
```

### Q: 如何查看调度器状态
A: 在GUI日志中查看：
- "调度器已启动" - 表示调度器正常启动
- "调度器运行中，当前时间: XX:XX" - 表示调度器正常运行

## 调试步骤

1. **检查任务配置**
   ```bash
   python test_schedule_manual.py
   ```
   选择选项1查看所有任务

2. **检查当前时间**
   确认当前时间与任务设置时间的关系

3. **查看GUI日志**
   在GUI中查看是否有调度器相关日志

4. **手动测试**
   使用手动测试工具模拟执行

5. **重置状态**
   如果任务从未运行，重置最后运行时间

## 预防措施

1. **设置合理的时间**
   - 避免设置已过的时间
   - 设置当前时间后几分钟进行测试

2. **保持GUI运行**
   - 定时任务需要GUI应用运行
   - 不要关闭GUI窗口

3. **定期检查日志**
   - 查看调度器运行状态
   - 检查任务执行情况

4. **备份配置**
   - 定期备份schedules.json
   - 记录重要任务配置

## 更新日志

- ✅ 增加详细的调试日志
- ✅ 改进异常处理机制
- ✅ 添加手动测试工具
- ✅ 优化重复检查逻辑
- ✅ 增加容错机制
